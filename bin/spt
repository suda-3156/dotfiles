#!/usr/bin/env bash
#
# spt - Snippet Picker Tool
#

FIND_SEARCH_DEPTH=4

if [ -z "$SNIPPETS_DIR" ]; then
  echo "Error: SNIPPETS_DIR is not set. Please set it in your environment variables."
  exit 1
fi

if [ -z "$EDITOR" ]; then
  EDITOR="code"
fi

if [ "$1" = "open" ]; then
  "$EDITOR" "$SNIPPETS_DIR"
  exit 0
fi

# Blacklist patterns
EXCLUDED_PATHS=(
  '*.git*'
  '*.venv*'
  '*node_modules*'
  '*__pycache__*'
  '*.pytest_cache*'
  '*dist*'
  '*build*'
  '*.ruff_cache*'
)

EXCLUDED_FILES=(
  '.DS_Store'
  'pnpm-lock.yaml'
  'yarn.lock'
  'uv.lock'
  'package-lock.json'
  '*.pyc'
  'Thumbs.db'
)

# Build find command with exclusions
find_args=()
for pattern in "${EXCLUDED_PATHS[@]}"; do
  find_args+=(-not -path "$pattern")
done
for pattern in "${EXCLUDED_FILES[@]}"; do
  find_args+=(-not -name "$pattern")
done

files=$(
  find \
  -L "$SNIPPETS_DIR" \
  -mindepth 1 \
  -maxdepth $FIND_SEARCH_DEPTH \
  -type f \
  "${find_args[@]}" \
  | sort
)

relative_path=$(echo "$files" | sed "s|$SNIPPETS_DIR/||g" | fzf)

if [ -n "$relative_path" ]; then
  cat "$SNIPPETS_DIR/$relative_path" | pbcopy
  echo "Copied '$relative_path' to clipboard."
fi